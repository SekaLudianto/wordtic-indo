<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crostic Indonesia</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- TAMBAHAN: Socket.IO Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>

    <!-- 4. Google Font (Poppins) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 5. Custom Styles -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overscroll-behavior: none;
        }
        /* Style untuk sel jawaban yang aktif */
        .cell-active {
            border-color: #FF9800 !important;
            box-shadow: 0 0 0 2px #FFD54F;
        }
        /* Style untuk highlight huruf kunci di grid fakta */
        .fact-cell-highlight {
            border-bottom-color: #FF9800 !important;
        }
        /* Sembunyikan scrollbar tapi tetap bisa di-scroll */
        #clue-list-container::-webkit-scrollbar,
        #chat-log::-webkit-scrollbar {
            display: none;
        }
        #clue-list-container,
        #chat-log {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --- CSS UNTUK FEEDBACK --- */
        .cell-correct {
            color: #16a34a; /* green-700 */
            border-color: #4ade80; /* green-400 */
        }
        .cell-wrong {
            color: #dc2626; /* red-600 */
            border-color: #f87171; /* red-400 */
        }
        .cell-wrong-word {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
            color: #dc2626; /* red-600 */
        }
        .cell-complete {
            position: relative;
            color: #16a34a; /* green-700 */
            border-color: #4ade80; /* green-400 */
            background-color: #f0fdf4; /* green-50 */
        }
        /* Tanda Ceklis */
        .cell-complete::after {
            content: 'âœ“';
            position: absolute;
            top: -8px;
            right: -2px;
            font-size: 12px;
            font-weight: bold;
            color: #16a34a;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <!-- ============================================= -->
    <!--     LAYAR HOME (PILIH PUZZLE)                 -->
    <!-- ============================================= -->
    <!-- PERBAIKAN: Tampilan home baru yang lebih simpel -->
    <div id="home-screen" class="w-full min-h-screen p-6 flex items-center justify-center">
        <main class="max-w-md w-full mx-auto space-y-6 bg-white p-8 rounded-2xl shadow-xl">
            <header class="text-center">
                <h1 class="text-4xl font-bold text-orange-600 mb-2">Crostic Indonesia</h1>
                <p class="text-lg text-slate-600">Ungkap fakta menarik lewat teka-teki!</p>
            </header>

            <!-- Koneksi TikTok -->
            <section>
                <h2 class="text-xl font-semibold text-slate-800 mb-4 text-center">Hubungkan ke TikTok LIVE</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <input type="text" id="tiktok-username" placeholder="@username" class="flex-grow w-full bg-slate-100 text-slate-900 placeholder-slate-400 border-2 border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-300 outline-none">
                    <button data-action="connect-tiktok" id="connect-button" class="w-full sm:w-auto bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                        Hubungkan
                    </button>
                </div>
                <div id="tiktok-status" class="text-center text-sm text-slate-600 mt-3 h-5">Belum terhubung.</div>
            </section>

            <!-- Tombol Mulai -->
            <section>
                <button data-action="start-game" id="start-game-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-slate-300 disabled:cursor-not-allowed disabled:hover:scale-100">
                    Mulai Main
                </button>
                <p id="game-status" class="text-center text-sm text-slate-500 mt-3 h-5"></p>
            </section>
        </main>
    </div>

    <!-- ============================================= -->
    <!--     LAYAR PUZZLE UTAMA                        -->
    <!-- ============================================= -->
    <div id="puzzle-screen" class="flex flex-col h-screen overflow-hidden hidden">
        
        <!-- Header -->
        <header class="w-full max-w-3xl mx-auto p-4 flex justify-between items-center text-slate-800">
            <button data-action="go-home" class="p-2 rounded-full hover:bg-orange-100 active:bg-orange-200" aria-label="Kembali ke Home">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            <h1 id="header-pack-name" class="text-xl font-semibold">
                <!-- Nama Pack oleh JS -->
            </h1>
            <div class="flex items-center space-x-2">
                <button data-action="use-hint" class="flex items-center space-x-1 px-3 py-2 rounded-full bg-orange-100 text-orange-700 hover:bg-orange-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="hint-icon-container">
                        <!-- Ikon (Wallet/Lightbulb) oleh JS -->
                    </span>
                    <span id="hint-count" class="font-medium text-sm">
                        <!-- Jumlah Hint oleh JS -->
                    </span>
                </button>
                <button data-action="toggle-info" class="p-2 rounded-full hover:bg-orange-100 active:bg-orange-200" aria-label="Informasi Puzzle">
                    <i data-lucide="info" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Mode Simulasi -->
        <div id="simulation-mode-container" class="w-full max-w-3xl mx-auto px-4 pt-0 pb-2 hidden">
            <div class="flex items-center gap-2 p-3 bg-white rounded-lg shadow-sm border border-orange-200">
                <input type="text" id="sim-comment" placeholder="Simulasi komen (misal: 1. A)" class="flex-grow bg-slate-100 text-sm rounded-md px-3 py-2 border border-slate-300 focus:ring-2 focus:ring-orange-500 outline-none">
                <button data-action="sim-send" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold px-4 py-2 rounded-md text-sm">
                    Kirim
                </button>
            </div>
        </div>

        <!-- Grid Fakta (Atas) -->
        <div id="fact-grid-container" class="w-full max-w-3xl mx-auto px-4 py-2 md:py-4">
            <div class="p-4 bg-white rounded-lg shadow-sm">
                <!-- Grid di-generate oleh JS -->
            </div>
        </div>

        <!-- Wrapper untuk Clue List -->
        <div class="flex-1 w-full max-w-3xl mx-auto px-4 overflow-y-hidden pb-4 flex flex-col md:flex-row md:gap-4">
            
            <!-- Kolom Clue -->
            <div id="clue-list-container" class="w-full h-full overflow-y-auto grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-2 pr-2">
                <!-- Daftar Clue di-generate oleh JS -->
            </div>

            <!-- Kolom Chat TikTok (Selalu tersembunyi, hanya untuk referensi) -->
            <div id="tiktok-chat-container" class="w-full md:w-1/3 h-[50%] md:h-full bg-white rounded-lg shadow-sm p-3 flex-col mt-4 md:mt-0 hidden">
                <h3 class="text-lg font-semibold text-center mb-2 pb-2 border-b">Komentar TikTok LIVE</h3>
                <div id="chat-log" class="flex-grow overflow-y-auto space-y-2 text-sm">
                    <p class="text-gray-500 text-center italic">Hubungkan ke LIVE untuk melihat komentar...</p>
                </div>
            </div>

        </div>

    </div>

    <!-- ============================================= -->
    <!--     MODAL-MODAL                               -->
    <!-- ============================================= -->

    <!-- Modal Info -->
    <div id="info-modal" class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-sm bg-white rounded-lg shadow-xl p-6 relative">
            <button data-action="toggle-info" class="absolute top-3 right-3 p-1 rounded-full text-slate-500 hover:bg-slate-100">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h2 class="text-xl font-semibold text-slate-900 mb-2">Informasi Puzzle</h2>
            <p class="text-sm text-slate-600 mb-1"><span class="font-medium">Pack:</span> <span id="info-pack"></span></p>
            <p class="text-sm text-slate-600 mb-1"><span class="font-medium">Level:</span> <span id="info-level"></span></p>
            <p class="text-sm text-slate-600 mb-4"><span class="font-medium">Author:</span> <span id="info-author"></span></p>
            <p class="text-xs text-slate-500 italic">
                Isi semua kotak jawaban untuk mengungkap fakta menarik di bagian atas!
            </p>
        </div>
    </div>

    <!-- Modal Selesai -->
    <div id="completion-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 md:p-8 text-center">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="check" class="w-10 h-10 text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 mb-3">Selamat!</h2>
            <p class="text-base text-slate-700 mb-5">Anda berhasil mengungkap fakta tersembunyi:</p>
            <p id="completion-fact" class="text-base md:text-lg font-semibold text-orange-600 bg-orange-50 p-4 rounded-lg mb-6">
                <!-- Fakta oleh JS -->
            </p>
            <!-- PERUBAHAN: Tombol dihilangkan, diganti prompt !next -->
            <div id="next-level-prompt">
                <p class="text-base text-slate-800 font-semibold animate-pulse">
                    Ketik <code class="bg-slate-200 text-red-600 px-2 py-1 rounded-md">!next</code> di chat untuk lanjut!
                </p>
            </div>
            <div id="all-complete-prompt" class="hidden">
                <p class="text-lg text-green-700 font-semibold mb-4">
                    Anda telah menyelesaikan semua level!
                </p>
                <button data-action="go-home" class="w-full px-5 py-3 rounded-lg bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition-colors">
                    Kembali ke Home
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!--     SCRIPT UTAMA                              -->
    <!-- ============================================= -->
    <script type="module">
        // --- TAMBAHAN: Kelas TikTokIOConnection ---
        class TikTokIOConnection {
            constructor(backendUrl) {
                this.socket = io(backendUrl);
                this.uniqueId = null;
                this.options = null;

                this.socket.on('connect', () => {
                    console.info("Socket connected!");
                    if (this.uniqueId) {
                        this.setUniqueId();
                    }
                })

                this.socket.on('disconnect', () => {
                    console.warn("Socket disconnected!");
                })

                this.socket.on('streamEnd', () => {
                    console.warn("LIVE has ended!");
                    this.uniqueId = null;
                })

                this.socket.on('tiktokDisconnected', (errMsg) => {
                    console.warn(errMsg);
                    if (errMsg && errMsg.includes('LIVE has ended')) {
                        this.uniqueId = null;
                    }
                });
            }

            connect(uniqueId, options) {
                this.uniqueId = uniqueId.replace(/^@/, '');
                this.options = options || {};
                this.setUniqueId();

                return new Promise((resolve, reject) => {
                    this.socket.once('tiktokConnected', resolve);
                    this.socket.once('tiktokDisconnected', reject);
                    setTimeout(() => {
                        reject('Connection Timeout');
                    }, 15000)
                })
            }

            setUniqueId() {
                this.socket.emit('setUniqueId', this.uniqueId, this.options);
            }

            on(eventName, eventHandler) {
                this.socket.on(eventName, eventHandler);
            }
        }

        // --- 1. DATA PUZZLE (MOCK) ---
        // PERUBAHAN: Data puzzle baru yang lebih pendek dan sulit
        const allPuzzles = [
          {
            id: 'level_1',
            pack: 'Fakta Singkat',
            level: 1,
            secretPhrase: 'CAHAYA LEBIH CEPAT',
            fact: 'Meskipun suara kencang, CAHAYA LEBIH CEPAT bergerak, itulah mengapa kita melihat kilat sebelum mendengar guntur.',
            author: 'Crostic',
            grid: [
              [1, 2, 3, 2, 4, 2, null, 5, 6, 7, 8, 3],
              [1, 6, 9, 2, 10, null, 1, 6, 9, 2, 10]
            ],
            clues: [
              { text: 'Tidak di... (melainkan di luar)', answer: 'DALAM', cells: [7, 2, 5, 2, 1] },
              { text: 'A... api (panas)', answer: 'BARA', cells: [6, 2, 3, 2] },
              { text: 'Alat musik petik dari Spanyol', answer: 'GITAR', cells: [10, 8, 10, 2, 3] },
              { text: 'Saya (Inggris)', answer: 'I', cells: [8] },
              { text: 'Lawan dari "stop"', answer: 'PLAY', cells: [9, 5, 2, 4] }
            ],
          },
          {
            id: 'level_2',
            pack: 'Fakta Singkat',
            level: 2,
            secretPhrase: 'KOPI DARI BIJI',
            fact: 'Banyak yang salah kira, KOPI DARI BIJI yang sebenarnya adalah biji dari buah ceri kopi yang dikeringkan dan dipanggang.',
            author: 'Crostic',
            grid: [
              [1, 2, 3, 4, null, 5, 2, 6, 4],
              [7, 4, 8, 4, null, 1, 2, 3, 4]
            ],
            clues: [
              { text: 'Segala sesuatu yang... (hidup)', answer: 'BERNYAWA', cells: [7, 6, 2, 1, 4, 2, 3, 2] },
              { text: 'Batang pohon yang besar', answer: 'POKOK', cells: [3, 2, 1, 2, 1] },
              { text: 'Tempat menyimpan uang', answer: 'BANK', cells: [7, 2, 1, 1] },
              { text: 'Tidur (Inggris)', answer: 'BOBO', cells: [7, 2, 7, 2] },
              { text: 'U... (panggilan untuk pria)', answer: 'BRO', cells: [7, 6, 2] },
              { text: 'Bahan pembuat tahu', answer: 'KEDELAI', cells: [1, 5, 5, 6, 2, 4] },
            ],
          },
          {
            id: 'level_3',
            pack: 'Fakta Singkat',
            level: 3,
            secretPhrase: 'MADU TIDAK BASI',
            fact: 'Karena kadar gula tinggi dan keasamannya, MADU TIDAK BASI dan bisa bertahan ribuan tahun jika disimpan dengan benar.',
            author: 'Crostic',
            grid: [
              [1, 2, 3, 4, null, 5, 6, 3, 2, 7],
              [8, 2, 9, 6, null, 1, 2, 3, 4]
            ],
            clues: [
              { text: 'I... (hewan air)', answer: 'IKAN', cells: [6, 7, 2, 1] },
              { text: 'Bahan bakar kendaraan', answer: 'BENSIN', cells: [8, 9, 1, 9, 6, 1] },
              { text: 'Alat musik pukul', answer: 'DRUM', cells: [3, 3, 4, 1] },
              { text: 'Lawan dari "sedih"', answer: 'TAWA', cells: [5, 2, 3, 2] },
              { text: 'Sangat kecil', answer: 'MIKRO', cells: [1, 6, 7, 3, 2] },
            ],
          }
        ];

        const STORAGE_KEY = 'crostic-indonesia-save-v2'; // v2 untuk data baru
        
        // --- 2. STATE APLIKASI ---
        let state = {
            currentPuzzleId: null,
            puzzleData: null,
            revealedMap: new Map(), // Map<number, string>
            activeCell: null, // { clueIndex: number, cellIndex: number }
            freeHints: 1,
            paidHints: 5,
            isComplete: false,
        };

        // --- TAMBAHAN: State Koneksi ---
        let tiktokConnection = null;

        // --- 3. DOM SELECTORS ---
        const homeScreen = document.getElementById('home-screen');
        const puzzleScreen = document.getElementById('puzzle-screen');
        // PERUBAHAN: Selector home baru
        const startGameButton = document.getElementById('start-game-button');
        const gameStatus = document.getElementById('game-status');
        
        const headerPackName = document.getElementById('header-pack-name');
        const hintIconContainer = document.getElementById('hint-icon-container');
        const hintCount = document.getElementById('hint-count');
        const hintButton = document.querySelector('[data-action="use-hint"]');

        const factGridContainer = document.getElementById('fact-grid-container').firstElementChild;
        const clueListContainer = document.getElementById('clue-list-container');

        const tiktokUsername = document.getElementById('tiktok-username');
        const connectButton = document.getElementById('connect-button');
        const tiktokStatus = document.getElementById('tiktok-status');
        const tiktokChatContainer = document.getElementById('tiktok-chat-container');
        const chatLog = document.getElementById('chat-log');

        const simContainer = document.getElementById('simulation-mode-container');

        const infoModal = document.getElementById('info-modal');
        const infoPack = document.getElementById('info-pack');
        const infoLevel = document.getElementById('info-level');
        const infoAuthor = document.getElementById('info-author');

        const completionModal = document.getElementById('completion-modal');
        const completionFact = document.getElementById('completion-fact');
        // PERUBAHAN: Selector prompt !next
        const nextLevelPrompt = document.getElementById('next-level-prompt');
        const allCompletePrompt = document.getElementById('all-complete-prompt');
        
        // --- 4. FUNGSI UTAMA ---

        /**
         * Menginisialisasi aplikasi
         */
        function init() {
            // renderHomeScreen(); // Dihapus, diganti updateHomeUI
            setupGlobalListeners();
            loadState(); // loadState akan memanggil updateHomeUI
            updateHomeUI();
            lucide.createIcons();
        }

        /**
         * Menampilkan layar (home atau puzzle)
         */
        function showPage(pageName) {
            homeScreen.classList.toggle('hidden', pageName !== 'home');
            puzzleScreen.classList.toggle('hidden', pageName !== 'puzzle');
        }

        /**
         * Setup event listener global (delegation)
         */
        function setupGlobalListeners() {
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action], [data-clue-index]');
                if (!target) return;

                const { action, clueIndex, cellIndex, id } = target.dataset;

                switch (action) {
                    case 'start-game': // Aksi baru
                        startOrContinueGame();
                        break;
                    case 'go-home':
                        goToHome();
                        break;
                    case 'use-hint':
                        useHint();
                        break;
                    case 'toggle-info':
                        toggleInfoModal();
                        break;
                    case 'connect-tiktok':
                        connectToTikTok();
                        break;
                    case 'sim-send':
                        const simCommentInput = document.getElementById('sim-comment');
                        if (simCommentInput) {
                            const comment = simCommentInput.value.trim();
                            if (comment) {
                                const simulatedMsg = { 
                                    comment: comment, 
                                    uniqueId: 'Simulator', 
                                    profilePictureUrl: 'https://placehold.co/40x40/orange/white?text=S' 
                                };
                                // PERUBAHAN: Kirim ke handler komen
                                handleComment(simulatedMsg);
                                simCommentInput.value = '';
                            }
                        }
                        break;
                }

                if (clueIndex !== undefined) {
                    setActiveCell(parseInt(clueIndex), parseInt(cellIndex));
                }
            });

            window.addEventListener('keydown', (e) => {
                if (state.currentPuzzleId === null) return;
                if (document.activeElement.tagName === 'INPUT') return;
                
                if (e.key.match(/^[a-z]$/i)) {
                    e.preventDefault();
                    handleKeyInput(e.key.toUpperCase());
                } else if (e.key === 'Backspace') {
                    e.preventDefault();
                    handleDelete();
                }
            });
        }
        
        // --- Fungsi Navigasi & Load ---

        /**
         * PERUBAHAN: Update UI di Home Screen
         */
        function updateHomeUI() {
            if (!startGameButton || !gameStatus) return;

            if (state.currentPuzzleId) {
                const currentPuzzle = allPuzzles.find(p => p.id === state.currentPuzzleId);
                if (currentPuzzle) {
                    startGameButton.textContent = `Lanjutkan Level ${currentPuzzle.level}`;
                    gameStatus.textContent = `Anda sedang di ${currentPuzzle.pack} #${currentPuzzle.level}`;
                } else {
                    // Reset jika data puzzle tidak valid
                    state.currentPuzzleId = null;
                    saveState(); // Simpan state yang sudah di-reset
                    startGameButton.textContent = 'Mulai Main';
                    gameStatus.textContent = 'Mulai dari Level 1';
                }
            } else {
                startGameButton.textContent = 'Mulai Main';
                gameStatus.textContent = 'Mulai dari Level 1';
            }

            // Tombol Mulai hanya aktif jika TikTok terhubung
            startGameButton.disabled = !tiktokConnection;
        }

        /**
         * PERUBAHAN: Memulai atau melanjutkan game
         */
        function startOrContinueGame() {
            if (!tiktokConnection) {
                if (tiktokStatus) {
                    tiktokStatus.textContent = 'Harap hubungkan TikTok terlebih dahulu!';
                    tiktokStatus.classList.add('text-red-600');
                }
                return;
            }

            let puzzleToLoad;
            if (state.currentPuzzleId) {
                puzzleToLoad = allPuzzles.find(p => p.id === state.currentPuzzleId);
            }
            
            // Jika tidak ada progres, atau progres tidak valid, mulai dari awal
            if (!puzzleToLoad) {
                puzzleToLoad = allPuzzles[0];
                // Reset state untuk puzzle baru
                state.currentPuzzleId = puzzleToLoad.id;
                state.revealedMap = new Map();
                state.isComplete = false;
                state.freeHints = 1; // Reset hint
                state.paidHints = 5;
            }
            
            loadPuzzle(puzzleToLoad);
        }

        /**
         * Kembali ke home
         */
        function goToHome() {
            // state.currentPuzzleId jangan di-reset, agar bisa "Lanjutkan"
            state.puzzleData = null;
            state.activeCell = null;
            if (completionModal) completionModal.classList.add('hidden'); // Tutup modal jika terbuka
            showPage('home');
            updateHomeUI(); // Update tombol "Lanjutkan"

            if (simContainer) simContainer.classList.add('hidden');
        }

        /**
         * Memuat puzzle baru
         */
        function loadPuzzle(puzzle) {
            // Cek apakah ini puzzle baru atau load dari storage
            if (state.currentPuzzleId !== puzzle.id) {
                state.currentPuzzleId = puzzle.id;
                state.revealedMap = new Map();
                state.freeHints = 1;
                state.paidHints = 5;
                state.isComplete = false;
            }
            
            state.puzzleData = puzzle;
            state.activeCell = null;

            if (completionModal) completionModal.classList.add('hidden'); // Selalu tutup modal saat load

            renderPuzzleUI();
            updateAllCells();
            checkCompletion(false); // Cek tanpa tampilkan modal
            
            // Tampilkan simulator jika tidak terhubung
            if (!tiktokConnection) {
                if (simContainer) simContainer.classList.remove('hidden');
            } else {
                if (simContainer) simContainer.classList.add('hidden');
            }

            checkAllClueFeedback();
            showPage('puzzle');
        }

        /**
         * PERUBAHAN: Memuat puzzle berikutnya
         */
        function loadNextPuzzle() {
            if (!state.puzzleData) return;

            const currentIndex = allPuzzles.findIndex(p => p.id === state.puzzleData.id);
            const nextIndex = currentIndex + 1;

            if (nextIndex < allPuzzles.length) {
                // Masih ada level berikutnya
                const nextPuzzle = allPuzzles[nextIndex];
                // Reset state untuk puzzle baru
                state.currentPuzzleId = nextPuzzle.id;
                state.revealedMap = new Map();
                state.isComplete = false;
                state.freeHints = 1; // Reset hint
                state.paidHints = 5;
                saveState(); // Simpan ID puzzle baru
                loadPuzzle(nextPuzzle);
            } else {
                // Semua puzzle selesai
                if (allCompletePrompt) allCompletePrompt.classList.remove('hidden');
                if (nextLevelPrompt) nextLevelPrompt.classList.add('hidden');
                // Jangan panggil goToHome(), biarkan modal terbuka
            }
        }


        // --- Fungsi Render UI Puzzle ---

        function renderPuzzleUI() {
            renderHeader();
            renderFactGrid();
            renderClueList();
            lucide.createIcons();
        }

        function renderHeader() {
            if (!state.puzzleData) return;
            if (headerPackName) {
                headerPackName.textContent = `${state.puzzleData.pack} #${state.puzzleData.level}`;
            }
            updateHintUI();
        }
        
        function updateHintUI() {
            const hasFree = state.freeHints > 0;
            if (hintIconContainer) {
                hintIconContainer.innerHTML = hasFree 
                    ? `<i data-lucide="wallet" class="w-4 h-4"></i>`
                    : `<i data-lucide="lightbulb" class="w-4 h-4"></i>`;
            }
            if (hintCount) {
                hintCount.textContent = hasFree ? state.freeHints : state.paidHints;
            }
            if (hintButton) {
                hintButton.disabled = state.freeHints === 0 && state.paidHints === 0;
            }
            lucide.createIcons();
        }

        function renderFactGrid() {
            if (!state.puzzleData) return;
            const keyLetters = new Set(state.puzzleData.clues.map(c => c.cells[0]));

            if (factGridContainer) {
                factGridContainer.innerHTML = state.puzzleData.grid.map(row => `
                    <div class="flex justify-center space-x-0.5 md:space-x-1 mb-1">
                        ${row.map(number => {
                            if (number === null) {
                                return `<div class="w-4 h-6 md:w-5 md:h-7"></div>`;
                            }
                            const isKey = keyLetters.has(number);
                            return `
                                <div class="flex flex-col items-center justify-center w-4 h-6 md:w-5 md:h-7">
                                    <div data-number="${number}" class="cell-number-${number} w-full h-full border-b-2 flex items-center justify-center text-xs md:text-sm font-semibold uppercase text-slate-900 ${isKey ? 'fact-cell-highlight border-orange-500' : 'border-slate-300'}">
                                    </div>
                                    <span class="text-[8px] md:text-[10px] text-slate-500 mt-0.5">${number}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `).join('');
            }
        }

        function renderClueList() {
            if (!state.puzzleData) return;
            if (clueListContainer) {
                // PERUBAHAN: Tata letak grid diatur di HTML (grid-cols-2 md:grid-cols-2 lg:grid-cols-3)
                clueListContainer.innerHTML = state.puzzleData.clues.map((clue, clueIndex) => `
                    <div class="p-2 md:p-3 bg-white rounded-lg shadow-sm">
                        <p class="text-xs md:text-sm text-slate-700 mb-2">${clue.text}</p>
                        <div class="flex flex-wrap gap-1 md:gap-1.5">
                            ${clue.cells.map((number, cellIndex) => `
                                <div class="flex flex-col items-center">
                                    <div data-clue-index="${clueIndex}" data-cell-index="${cellIndex}" data-number="${number}" class="cell-number-${number} w-6 h-7 md:w-7 md:h-8 rounded-md flex items-center justify-center text-base md:text-lg font-semibold uppercase bg-white shadow-sm border border-slate-300 cursor-pointer">
                                    </div>
                                    <span class="text-[9px] md:text-xs text-slate-500 mt-1">${number}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // --- Fungsi Koneksi TikTok ---

        function connectToTikTok() {
            if (!tiktokUsername || !tiktokStatus || !connectButton) return;

            const uniqueId = tiktokUsername.value;
            if (!uniqueId) {
                tiktokStatus.textContent = 'Nama pengguna tidak boleh kosong!';
                tiktokStatus.classList.add('text-red-600');
                return;
            }

            tiktokStatus.textContent = `Menghubungkan ke @${uniqueId}...`;
            tiktokStatus.classList.remove('text-red-600');
            connectButton.disabled = true;

            const backendUrl = "https://tiktok-server-production-e573.up.railway.app";
            tiktokConnection = new TikTokIOConnection(backendUrl);

            tiktokConnection.connect(uniqueId, {
                enableExtendedGiftInfo: true
            }).then(state => {
                tiktokStatus.textContent = `Terhubung ke Room ID: ${state.roomId}`;
                tiktokStatus.classList.remove('text-red-600');
                tiktokStatus.classList.add('text-green-600');
                if (startGameButton) startGameButton.disabled = false; // Aktifkan tombol Mulai
                setupTikTokListeners();
            }).catch(errorMessage => {
                tiktokStatus.textContent = `Gagal terhubung: ${errorMessage}`;
                tiktokStatus.classList.add('text-red-600');
                connectButton.disabled = false;
                if (startGameButton) startGameButton.disabled = true; // Tetap nonaktif
                tiktokConnection = null;
            });
        }

        function setupTikTokListeners() {
            if (chatLog) {
                chatLog.innerHTML = '<p class="text-green-600 text-center">Terhubung! Menunggu komentar...</p>';
            }
            
            tiktokConnection.on('chat', handleComment); // Kirim ke handler komen

            tiktokConnection.on('disconnect', () => {
                if (tiktokStatus) tiktokStatus.textContent = 'Koneksi terputus.';
                if (tiktokStatus) tiktokStatus.classList.add('text-red-600');
                if (connectButton) connectButton.disabled = false;
                if (startGameButton) startGameButton.disabled = true; // Nonaktifkan tombol Mulai
                tiktokConnection = null;
            });

            tiktokConnection.on('streamEnd', () => {
                if (tiktokStatus) tiktokStatus.textContent = 'Siaran LIVE telah berakhir.';
                if (tiktokStatus) tiktokStatus.classList.add('text-red-600');
                if (connectButton) connectButton.disabled = false;
                if (startGameButton) startGameButton.disabled = true; // Nonaktifkan tombol Mulai
                tiktokConnection = null;
            });
        }

        /**
         * PERUBAHAN: Handler terpusat untuk komen (TikTok & Simulasi)
         */
        function handleComment(msg) {
            const comment = msg.comment.trim();
            let isAnswer = false;

            // 1. Cek untuk perintah !next
            if (state.isComplete && comment.trim().toUpperCase() === '!NEXT') {
                loadNextPuzzle();
                return; // Selesai
            }

            // 2. Cek untuk jawaban puzzle
            if (state.puzzleData && !state.isComplete) {
                const match = comment.match(/^(\d+)\s*\.\s*([A-Z])$/i);

                if (match) {
                    const number = parseInt(match[1]);
                    const letter = match[2].toUpperCase();
                    
                    const exists = state.puzzleData.clues.some(c => c.cells.includes(number));
                    
                    if (exists) {
                        isAnswer = true;
                        if (state.revealedMap.get(number) !== letter) {
                            state.revealedMap.set(number, letter);
                            updateAllCells(number);
                            checkFeedbackForNumber(number);
                            checkCompletion();
                            saveState();
                        }
                    }
                }
            }

            // 3. Tambahkan ke log (jika perlu)
            // addCommentToLog(msg, isAnswer); // Dihilangkan sesuai permintaan
        }

        // Dihapus karena chat log tidak terlihat
        // function addCommentToLog(msg, isAnswer) { ... }


        // --- Fungsi Logika Game ---

        function handleKeyInput(letter) {
            if (!state.activeCell || state.isComplete) return;

            const { clueIndex, cellIndex } = state.activeCell;
            const clue = state.puzzleData.clues[clueIndex];
            const number = clue.cells[cellIndex];
            
            state.revealedMap.set(number, letter.toUpperCase());
            updateAllCells(number);
            checkFeedbackForNumber(number);
            autoAdvanceActiveCell();
            checkCompletion();
            saveState();
        }

        function handleDelete() {
            if (!state.activeCell || state.isComplete) return;

            const { clueIndex, cellIndex } = state.activeCell;
            const clue = state.puzzleData.clues[clueIndex];
            let numberToUpdate;
            let numberToClearFeedback;
            
            if (cellIndex > 0) {
                const prevCellIndex = cellIndex - 1;
                numberToUpdate = clue.cells[prevCellIndex];
                numberToClearFeedback = clue.cells[cellIndex];
                state.revealedMap.delete(numberToUpdate);
                setActiveCell(clueIndex, prevCellIndex);
            } else {
                numberToUpdate = clue.cells[cellIndex];
                numberToClearFeedback = numberToUpdate;
                state.revealedMap.delete(numberToUpdate);
            }
            
            updateAllCells(numberToUpdate);
            checkFeedbackForNumber(numberToUpdate);
            if (numberToClearFeedback !== numberToUpdate) {
                checkFeedbackForNumber(numberToClearFeedback);
            }
            state.isComplete = false;
            saveState();
        }
        
        function updateAllCells(specificNumber = null) {
            const update = (number, letter) => {
                const cells = document.querySelectorAll(`.cell-number-${number}`);
                cells.forEach(cell => {
                    cell.textContent = letter;
                });
            };

            if (specificNumber !== null) {
                const letter = state.revealedMap.get(specificNumber) || '';
                update(specificNumber, letter);
            } else {
                state.revealedMap.forEach((letter, number) => {
                    update(number, letter);
                });
            }
        }
        
        function setActiveCell(clueIndex, cellIndex) {
            const oldActive = document.querySelector('.cell-active');
            if (oldActive) {
                oldActive.classList.remove('cell-active');
            }

            const newActive = document.querySelector(`[data-clue-index="${clueIndex}"][data-cell-index="${cellIndex}"]`);
            if (newActive) {
                newActive.classList.add('cell-active');
                state.activeCell = { clueIndex, cellIndex };
                newActive.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function autoAdvanceActiveCell() {
            if (!state.activeCell) return;
            
            const { clueIndex, cellIndex } = state.activeCell;
            const clue = state.puzzleData.clues[clueIndex];

            if (cellIndex < clue.cells.length - 1) {
                setActiveCell(clueIndex, cellIndex + 1);
            } else if (clueIndex < state.puzzleData.clues.length - 1) {
                setActiveCell(clueIndex + 1, 0);
            } else {
                const oldActive = document.querySelector('.cell-active');
                if (oldActive) oldActive.classList.remove('cell-active');
                state.activeCell = null;
            }
        }

        function checkCompletion(showModal = true) {
            if (!state.puzzleData) return;

            for (const clue of state.puzzleData.clues) {
                const userAnswer = clue.cells.map(num => state.revealedMap.get(num) || '').join('');
                if (userAnswer !== clue.answer) {
                    state.isComplete = false; 
                    return;
                }
            }

            // Jika sampai sini, semua jawaban benar
            state.isComplete = true;
            checkAllClueFeedback(); // Tampilkan semua ceklis
            saveState(); // Simpan status 'isComplete'

            if (showModal) {
                const fullFact = state.puzzleData.fact;
                const secret = state.puzzleData.secretPhrase;

                const highlightedFact = fullFact.replace(
                    secret, 
                    `<strong class="text-orange-700">${secret}</strong>`
                );

                if (completionFact) {
                    completionFact.innerHTML = `"${highlightedFact}"`;
                }
                
                // Cek apakah ini level terakhir
                const currentIndex = allPuzzles.findIndex(p => p.id === state.puzzleData.id);
                if (currentIndex === allPuzzles.length - 1) {
                    // Level terakhir
                    if (allCompletePrompt) allCompletePrompt.classList.remove('hidden');
                    if (nextLevelPrompt) nextLevelPrompt.classList.add('hidden');
                } else {
                    // Masih ada level
                    if (allCompletePrompt) allCompletePrompt.classList.add('hidden');
                    if (nextLevelPrompt) nextLevelPrompt.classList.remove('hidden');
                }

                if (completionModal) {
                    completionModal.classList.remove('hidden');
                }
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        }

        function useHint() {
            if (state.isComplete || (state.freeHints === 0 && state.paidHints === 0)) return;

            let hintApplied = false;
            let number;
            for (const clue of state.puzzleData.clues) {
                for (let i = 0; i < clue.cells.length; i++) {
                    number = clue.cells[i];
                    const correctLetter = clue.answer[i];
                    const userLetter = state.revealedMap.get(number);

                    if (!userLetter || userLetter !== correctLetter) {
                        state.revealedMap.set(number, correctLetter);
                        updateAllCells(number);
                        hintApplied = true;
                        break;
                    }
                }
                if (hintApplied) break;
            }

            if (hintApplied) {
                if (state.freeHints > 0) {
                    state.freeHints -= 1;
                } else {
                    state.paidHints -= 1;
                }
                updateHintUI();
                if (number) {
                    checkFeedbackForNumber(number);
                }
                checkCompletion();
                saveState();
            }
        }
        
        function shareToWhatsApp() {
            // Fungsi ini tidak lagi dipanggil, tapi tidak apa-apa
            if (!state.puzzleData) return;
            const text = `Saya baru saja menyelesaikan puzzle Crostic dan menemukan fakta ini:\n\n"${state.puzzleData.fact}"\n\nCoba main juga!`;
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // --- Fungsi Modal & Penyimpanan ---

        function toggleInfoModal() {
            if (!infoModal) return;
            if (state.puzzleData) {
                if (infoPack) infoPack.textContent = state.puzzleData.pack;
                if (infoLevel) infoLevel.textContent = state.puzzleData.level;
                if (infoAuthor) infoAuthor.textContent = state.puzzleData.author;
            }
            infoModal.classList.toggle('hidden');
        }

        // --- FUNGSI FEEDBACK ---

        function checkAllClueFeedback() {
            if (!state.puzzleData) return;
            state.puzzleData.clues.forEach((clue, index) => {
                checkFeedbackForClue(index);
            });
        }

        function checkFeedbackForNumber(number) {
            if (!state.puzzleData) return;
            state.puzzleData.clues.forEach((clue, index) => {
                if (clue.cells.includes(number)) {
                    checkFeedbackForClue(index);
                }
            });
        }

        function checkFeedbackForClue(clueIndex) {
            if (!state.puzzleData || !clueListContainer) return;

            const clue = state.puzzleData.clues[clueIndex];
            const clueCells = clueListContainer.querySelectorAll(`[data-clue-index="${clueIndex}"] [data-cell-index]`);
            
            if (clueCells.length === 0) return;

            let userAnswer = "";
            let isComplete = true;

            for (const num of clue.cells) {
                const userLetter = state.revealedMap.get(num);
                if (!userLetter) {
                    isComplete = false;
                }
                userAnswer += userLetter || " ";
            }

            if (isComplete) {
                if (userAnswer === clue.answer) {
                    clueCells.forEach(cell => {
                        cell.classList.add('cell-correct', 'cell-complete');
                        cell.classList.remove('cell-wrong', 'cell-wrong-word');
                    });
                } else {
                    clueCells.forEach(cell => {
                        cell.classList.add('cell-wrong-word');
                        cell.classList.remove('cell-correct', 'cell-wrong', 'cell-complete');
                    });
                }
            } else {
                clueCells.forEach((cell, i) => {
                    const num = clue.cells[i];
                    const userLetter = state.revealedMap.get(num);
                    const correctLetter = clue.answer[i];

                    cell.classList.remove('cell-wrong-word', 'cell-complete');

                    if (userLetter) {
                        if (userLetter === correctLetter) {
                            cell.classList.add('cell-correct');
                            cell.classList.remove('cell-wrong');
                        } else {
                            cell.classList.add('cell-wrong');
                            cell.classList.remove('cell-correct');
                        }
                    } else {
                        cell.classList.remove('cell-correct', 'cell-wrong');
                    }
                });
            }
        }

        /**
         * Simpan progres ke localStorage
         */
        function saveState() {
            const dataToSave = {
                currentPuzzleId: state.currentPuzzleId,
                revealedMap: Array.from(state.revealedMap.entries()),
                freeHints: state.freeHints,
                paidHints: state.paidHints,
                isComplete: state.isComplete,
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }

        /**
         * Muat progres dari localStorage
         */
        function loadState() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    const puzzle = allPuzzles.find(p => p.id === parsedData.currentPuzzleId);
                    
                    if (puzzle) {
                        state.currentPuzzleId = parsedData.currentPuzzleId;
                        state.revealedMap = new Map(parsedData.revealedMap || []);
                        state.freeHints = parsedData.freeHints ?? 1;
                        state.paidHints = parsedData.paidHints ?? 5;
                        state.isComplete = parsedData.isComplete ?? false;
                        
                        // Jangan load puzzle di sini, biarkan user klik "Lanjutkan"
                        // loadPuzzle(puzzle, true); 
                    }
                } catch (e) {
                    console.error("Gagal memuat progres:", e);
                    localStorage.removeItem(STORAGE_KEY);
                }
            }
            updateHomeUI(); // Panggil ini setelah load state selesai
        }
        
        // --- Mulai Aplikasi ---
        init();

    </script>
</body>
</html>
